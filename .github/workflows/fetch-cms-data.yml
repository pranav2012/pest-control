name: Fetch CMS Data

on:
    workflow_dispatch: # Allows manual triggering
    repository_dispatch:
        types: [cms_update] # Triggered when webhook sends event with type 'cms_update'

jobs:
    fetch-and-commit:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history for proper git diff
                  token: ${{ secrets.PAT_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 8

            - name: Install dependencies
              run: pnpm install

            - name: Run fetch-cms-data script
              env:
                  NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
                  NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
                  SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
              run: pnpm run fetch-cms-data

            - name: Check for changes
              id: git-check
              run: |
                  git add .
                  if git diff --staged --quiet; then
                    echo "changes=false" >> $GITHUB_OUTPUT
                  else
                    echo "changes=true" >> $GITHUB_OUTPUT
                  fi

            - name: Create Pull Request
              if: steps.git-check.outputs.changes == 'true'
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.PAT_TOKEN }}
                  commit-message: "chore: update CMS data"
                  title: "Update CMS Data"
                  body: |
                      This PR contains the latest updates from the CMS.

                      Changes were automatically generated by the CMS webhook.
                  branch: update-cms-data
                  base: main
                  labels: |
                      automated pr
                      cms update
