name: Fetch CMS Data

on:
    workflow_dispatch: # Allows manual triggering
    repository_dispatch:
        types: [cms_update] # Triggered when webhook sends event with type 'cms_update'

jobs:
    fetch-and-commit:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history for proper git diff

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 8

            - name: Install dependencies
              run: pnpm install

            - name: Run fetch-cms-data script
              env:
                  NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
                  NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
                  SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
              run: pnpm run fetch-cms-data

            - name: Check for changes
              id: git-check
              run: |
                  git add .
                  if git diff --staged --quiet; then
                    echo "changes=false" >> $GITHUB_OUTPUT
                  else
                    echo "changes=true" >> $GITHUB_OUTPUT
                  fi

            - name: Commit and push if changes exist
              if: steps.git-check.outputs.changes == 'true'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git commit -m "chore: update CMS data [skip ci]"
                  git push
